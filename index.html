<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>We Deliver — Kasi Play (Phase 1)</title>
  
  <style>
    /* =====================================================
       THEME — Smoke (grey), Coal (black), Fire (gold)
       ===================================================== */
    :root{
      --smoke:#F3F4F6;      /* light grey background */
      --paper:#FFFFFF;      /* card surfaces */
      --coal:#0B0E10;       /* primary ink */
      --coal-2:#161B22;     /* secondary ink */
      --muted:#6B7280;      /* captions */
      --gold:#D4AF37;       /* fire gold */
      --gold-2:#F2D36B;     /* soft gold */
      --line:rgba(11,14,16,.12);
      --radius:18px;        /* rounded corners */
      --shadow:0 16px 50px rgba(11,14,16,.12);
      --shadow-sm:0 8px 24px rgba(11,14,16,.10);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Manrope",system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      color:var(--coal);
      /* FIX: Restored subtle background gradient */
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(212,175,55,.08), transparent 60%),
        radial-gradient(1200px 600px at 110% 120%, rgba(15,20,25,.06), transparent 60%),
        var(--smoke);
      min-height:100svh;
      overflow-x: hidden; /* Prevents horizontal scroll */
    }

    /* SVG Icon styles */
    .icon {
      display: inline-block;
      width: 1em;
      height: 1em;
      stroke-width: 0;
      stroke: currentColor;
      fill: currentColor;
      vertical-align: middle;
    }
    .icon-fill { fill: currentColor; stroke: none; }
    .icon-stroke { fill: none; stroke: currentColor; stroke-width: 2px; }

    /* Layout: Full width on mobile, container on desktop */
    .container{
      width: 100%; /* Mobile-first: full width */
      margin-inline:auto;
    }

    /* ---------------- NAV (Desktop) ---------------- */
    .nav{
      display: none; /* Mobile-first: hidden */
      position:sticky;top:0;z-index:50;
      backdrop-filter:blur(8px) saturate(1.1);
      /* UPDATED: Back to white */
      background:var(--paper);
      border-bottom:1px solid var(--line);
    }
    /* UPDATED: Use grid for true center */
    .nav-inner{
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding:14px 0
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
    .logo{
      width:42px;height:42px;
      border-radius:14px;display:grid;place-items:center;
      background:radial-gradient(80% 80% at 30% 30%, var(--gold-2), var(--gold));
      color:#111;box-shadow:var(--shadow-sm);
    }
    .logo span{font-size:22px}
    .nav-links{display:flex;gap:12px;align-items:center; justify-self: end;} /* Align right */
    .link{color:var(--coal);opacity:.9;text-decoration:none;font-weight:700}
    .button{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;border-radius:14px;border:1px solid var(--line);background:var(--paper);color:var(--coal);font-weight:800;cursor:pointer;transition:transform .04s ease, box-shadow .2s}
    .button:hover{box-shadow:var(--shadow-sm)}
    .button.primary{background:linear-gradient(135deg,var(--gold),var(--gold-2));border:0;color:#111;box-shadow:0 14px 40px rgba(212,175,55,.28)}
    .button.whatsapp{background:linear-gradient(135deg,#25D366,#128C7E);border:0;color:#fff;box-shadow:0 14px 40px rgba(18,140,126,.35)}
    .button.danger{background:linear-gradient(135deg,#ff7a7a,#ff3b3b);border:0;color:#fff}
    .button:active{transform:translateY(1px)}
    .button,.pill,.qbtn,.remove{min-height:44px}
    .button{min-height:48px}
    
    /* Disabled button style */
    .button.disabled {
      background: var(--smoke);
      color: var(--muted);
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* NEW: Nav Timer */
    .nav-timer {
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .nav-timer .date-time {
      display: block;
      font-weight: 700;
      color: var(--coal);
      font-size: 1rem;
      line-height: 1.2;
    }
    .nav-timer .countdown {
      display: block;
      font-size: 0.85rem;
      font-weight: 800;
    }
    .nav-timer .countdown.open {
      color: var(--gold);
    }
    .nav-timer .countdown.closed {
      color: #b00; /* Red */
    }
    #nav-timer-mobile {
      display: none; /* Hide mobile timer by default */
      margin-top: 8px;
    }


    /* ---------------- NAV (Mobile) ---------------- */
    .nav-mobile {
      display: grid; /* Show on mobile */
      grid-template-columns: repeat(3, 1fr);
      position: sticky;
      bottom: 0;
      z-index: 50;
      /* UPDATED: Back to white */
      background: var(--paper);
      backdrop-filter: blur(10px) saturate(1.1);
      border-top: 1px solid var(--line);
      padding: 6px 10px 10px 10px; /* More padding at bottom for safe area */
    }
    .nav-mobile .n-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-weight: 800;
      font-size: 0.75rem; /* 12px */
      color: var(--muted);
      text-decoration: none;
      padding: 8px 4px;
      border-radius: 12px;
    }
    .nav-mobile .n-link .icon {
      font-size: 24px;
    }
    .nav-mobile .n-link.active {
      color: var(--coal);
      background: rgba(212,175,55,.15); /* Soft gold background */
    }
    .nav-mobile .n-link.cart-link {
      position: relative;
    }
    /* Cart count badge */
    .n-link .badge {
      position: absolute;
      top: 4px;
      right: 18px;
      background: var(--gold);
      color: #111;
      font-size: 10px;
      font-weight: 900;
      line-height: 1;
      padding: 3px 5px;
      border-radius: 99px;
      min-width: 18px;
      text-align: center;
      border: 2px solid #fff;
    }

    /* Disabled state for mobile nav */
    .n-link.disabled {
      color: #ccc !important;
      /* UPDATED: Back to white */
      background: var(--paper) !important;
      pointer-events: none;
      cursor: not-allowed;
      opacity: 0.6;
    }


    /* ---------------- HERO ---------------- */
    /* Mobile-first: Full width with padding */
    .hero{
      min-height:auto;
      padding: 16px; /* Reduced for less scroll */
    }
    .hero .grid{
      display:grid;
      gap:22px;
      align-items:start; /* Changed from center */
      grid-template-columns:1fr;
    }

    .hero-brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .hero-logo{
      width:72px;height:72px;
      border-radius:18px;display:grid;place-items:center;
      background:radial-gradient(80% 80% at 30% 30%, var(--gold-2), var(--gold));
      color:#111;box-shadow:var(--shadow);
    }
    .hero-logo .icon{font-size:34px;line-height:1}
    .hero-title{font-family:"Quicksand",Manrope,system-ui;font-weight:700;font-size:clamp(28px,5vw,52px);line-height:1.06;letter-spacing:.2px;}

    /* Message for operating hours */
    .operating-message {
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      /* margin-top: 12px; */ /* Removed margin */
      text-align: center;
      box-shadow: var(--shadow-sm);
    }
    .operating-message h3 {
      font-weight: 900;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .operating-message p {
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 4px;
      line-height: 1.4;
    }
    .contact-info {
      margin-top: 16px;
      font-weight: 700;
    }
    .contact-info p {
      margin-bottom: 8px;
    }
    .contact-info a {
      color: var(--coal);
      text-decoration: none;
      font-weight: 800;
    }
    .contact-info a:hover {
      text-decoration: underline;
    }
    
    /* Social Media Buttons */
    .social-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap; /* Added for safety */
    }
    .social-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 999px; /* circle */
      background: var(--paper);
      color: var(--coal);
      border: 1px solid var(--line);
      box-shadow: var(--shadow-sm);
      text-decoration: none;
      transition: transform .1s ease, box-shadow .1s ease;
    }
    .social-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .social-btn .icon {
      font-size: 24px;
    }
    .social-btn.wa { color: #25D366; }
    .social-btn.fb { color: #1877F2; }
    .social-btn.ig { color: #E4405F; }
    .social-btn.tk { color: #000000; }
    .social-btn.x { color: #000000; }
    .social-btn.call { color: #0B0E10; }


    .ride-anim{display:none} /* replaced by ride-photos */
    .hero-bg{background:radial-gradient(800px 320px at 20% 0%, rgba(212,175,55,.10), transparent 60%), linear-gradient(180deg,#0F1418 0%, #111418 100%);border-radius:16px;padding:8px}
    .ride-photos{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow:var(--shadow-sm);
      height:clamp(220px, 30vh, 420px); /* Reduced for less scroll */
    }
    .ride-photos img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;animation:fade 16s infinite ease-in-out;background:#e5e7eb;transition:opacity .3s ease}
    .ride-photos img:nth-child(1){animation-delay:0s;opacity:1}
    .ride-photos img:nth-child(2){animation-delay:4s}
    .ride-photos img:nth-child(3){animation-delay:8s}
    .ride-photos img:nth-child(4){animation-delay:12s}
    @keyframes fade{0%,25%{opacity:1}33%,100%{opacity:0}}
    .ride-photos .sticker{position:absolute;left:12px;bottom:12px;background:rgba(212,175,55,.95);color:#111;padding:6px 10px;border-radius:12px;font-weight:900;letter-spacing:.02em}
    @media (prefers-reduced-motion: reduce){.ride-photos img{animation:none;opacity:1}}

    .zone-panel{margin-top:12px;background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:12px;display:grid;gap:10px}
    .caption-title{font-weight:900;font-size:18px;letter-spacing:.02em}
    .zones{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap: 12px;align-items:flex-start}
    @media(min-width:640px){.zones{gap:12px}}

    .pill{
      padding:12px 14px;
      border-radius:999px;
      background:#fff;
      border:2px solid rgba(22,27,34,.12);
      color:var(--coal);
      font-weight:800;
      text-align:center;
      cursor:pointer;
      transition:transform .05s ease, background .18s;
      min-height:44px;
    }
    .pill:hover{transform:translateY(-2px)}
    .pill.active,.pill:focus{background:linear-gradient(135deg,var(--gold),var(--gold-2));color:#111}

    /* Services grid (replaces any photos) */
    .hero-card{
      position:relative;
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      border:1px solid var(--line);
      min-height: auto; /* Reduced for less scroll */
      background:#fff;
      margin-top: 12px; /* Added margin */
    }
    .hero-services{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;padding:16px}
    .svc{
      display:grid;
      gap:6px;
      align-content:start;
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow-sm);
      padding:12px;
      align-items: center;
      text-align: center;
    }
    .s-ico{font-size:28px;line-height:1; margin: auto; color: var(--gold);}
    .s-name{font-weight:900}
    .s-desc{color:var(--muted);font-weight:700;font-size:.9rem}

    /* Lists & cards */
    .section{
      padding: 16px; /* Reduced for less scroll */
      border-top:1px solid var(--line);
      /* REMOVED: padding-bottom: 96px; */
    }
    /* Add padding to last child to clear footer */
    .hero {
      /* REMOVED: padding-bottom: 96px; */
    }
    
    .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow-sm)}
    .grid-auto{display:grid;grid-template-columns:1fr;gap:12px}

    /* NEW: "Can't find it?" card */
    .whatsapp-card {
      background: linear-gradient(135deg, var(--coal), var(--coal-2));
      color: var(--paper);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow-sm);
      margin-top: 16px;
    }
    .whatsapp-card h3 {
      font-weight: 900;
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .whatsapp-card p {
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 16px;
    }
    .whatsapp-card .button.whatsapp {
      width: 100%;
      max-width: 300px;
    }
    
    .rest{display:grid;grid-template-columns:92px 1fr auto;gap:12px;align-items:center;border-radius:16px;background:#fff;padding:12px;border:1px solid var(--line);box-shadow:var(--shadow-sm);cursor:pointer}
    .rest .ph{width:92px;aspect-ratio:4/3;border-radius:12px;background:#eee;background-size:cover;background-position:center}
    .rest h3{font-size:1.1rem}
    .rest > div:last-child{font-size:22px;opacity:.7}
    .rest .icon { font-size: 20px; color: var(--muted); }

    .menu-banner{height:220px;border-radius:18px;background:linear-gradient(135deg,var(--gold),var(--gold-2));border:1px solid var(--line)}
    
    /* UPDATED: Combined grid rules */
    .menu-grid, #restaurant-list {
      display:grid;
      grid-template-columns:1fr;
      gap:10px
    }
    /* Responsive grids for lists */
    @media(min-width:520px){
      #restaurant-list,
      .menu-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media(min-width:900px){
      .menu-grid{
        grid-template-columns: repeat(3, 1fr);
      }
    }
    /* END UPDATED grid rules */

    .menu-item{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;display:grid;gap:6px;box-shadow:var(--shadow-sm)}
    .price{font-weight:900}

    /* Utility text classes added */
    .muted{color:var(--muted);font-weight:700}
    .small{color:var(--muted);font-weight:700;font-size:.9rem}
    .qtitle{font-weight:900}
    /* Quick restaurant card */
    .rcard{
      display:flex;
      align-items:center;
      gap:10px;
      /* min-width:240px; */ /* FIX: Removed this to prevent overflow */
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      box-shadow:var(--shadow-sm);
      cursor:pointer
    }
    .rcard .ph{width:92px;height:72px;border-radius:10px;background:#eee;background-size:cover;background-position:center}

    /* NEW: Disabled state for popular cards */
    .rcard.disabled {
      opacity: 0.6;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* Cart */
    .cart{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow-sm)}
    .row{display:grid;grid-template-columns:1fr auto auto auto;gap:12px;align-items:center;padding:10px 0;border-bottom:1px dashed var(--line)}
    .row:last-child{border-bottom:0}
    .qty{display:inline-grid;grid-auto-flow:column;grid-auto-columns:34px;align-items:center;justify-content:center;gap:8px}
    .qbtn{height:34px;width:34px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer}
    .remove{height:34px;width:34px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer; color: #b00;}
    .total{display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:12px;border-top:2px solid var(--line);font-weight:900}

    /* Inputs */
    .field{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;background:#fff;border:1px solid var(--line);padding:12px;border-radius:14px;box-shadow:var(--shadow-sm)}
    .field .icon { font-size: 20px; color: var(--muted); }
    .field.search-field { grid-template-columns: auto 1fr auto; }
    .field input,.field textarea{width:100%;background:transparent;border:0;color:var(--coal);font-weight:700;outline:0}
    .field textarea{min-height:72px;resize:vertical}

    .button:focus-visible,.link:focus-visible,input:focus-visible,textarea:focus-visible{outline:2px solid var(--gold-2);outline-offset:2px}

    /* Bottom progress dock */
    .dock{
      /* No longer sticky on mobile */
      display: none; /* Hidden by default, JS will show it */
      z-index:45;
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(10px) saturate(1.1);
      border-top:1px solid var(--line);
      margin-top: 16px; /* Add space when it's static */
    }
    .dock-inner{max-width:1200px;margin:auto;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:10px}
    .dot{display:flex;flex-direction:column;align-items:center;gap:6px;font-weight:800;color:var(--muted)}
    .dot .b{height:36px;width:36px;border-radius:12px;border:2px solid var(--line);display:grid;place-items:center;background:#fff}
    .dot .b .icon { font-size: 20px; }
    .dot.active{color:var(--coal)}
    .dot.active .b{background:linear-gradient(135deg,var(--gold),var(--gold-2));border:0;color:#111}

    /* Preview block wraps on mobile */
    .preview{
      white-space:pre-wrap;
      word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
      background:#fff;
      max-height: 40vh; /* Set max height */
      overflow-y: auto; /* Allow scrolling */
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
    }
    
    /* NEW: Footer Watermark */
    .app-footer {
      text-align: center;
      padding: 16px;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--muted);
      /* This padding keeps it clear of the mobile nav */
      padding-bottom: 110px; 
    }
    
    /* NEW: Order Success Page Styles */
    .success-icon {
      font-size: 64px;
      color: var(--gold);
      text-align: center;
      margin-bottom: 16px;
      line-height: 1;
    }
    .payment-options {
      margin-top: 24px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 520px) {
      .payment-options {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .payment-method {
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }
    .payment-method h3 {
      font-weight: 900;
      font-size: 1.2rem;
      border-bottom: 2px solid var(--gold-2);
      padding-bottom: 8px;
      margin-bottom: 12px;
    }
    .payment-method p {
      font-weight: 700;
      color: var(--muted);
      line-height: 1.5;
    }
    .payment-method p strong {
      color: var(--coal);
    }


    @media (min-width: 768px) {
      .app-footer {
        padding-bottom: 16px; /* Reset on desktop */
      }
    }


    /* =======================================
       Order Preview Modal
       ======================================= */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-box {
      background: var(--paper);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 500px;
      overflow: hidden;
      animation: modal-fade-in 0.2s ease-out;
    }
    @keyframes modal-fade-in {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--line);
    }
    .modal-header h2 {
      font-size: 1.25rem;
      font-weight: 900;
    }
    .modal-close {
      font-size: 24px;
      font-weight: 800;
      color: var(--muted);
      cursor: pointer;
      background: none;
      border: none;
      line-height: 1;
    }
    .modal-content {
      padding: 16px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .order-meta {
      background: var(--smoke);
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .order-meta p {
      font-weight: 700;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .order-meta p span {
      color: var(--coal);
      font-weight: 900;
    }
    .modal-footer {
      padding: 16px;
      border-top: 1px solid var(--line);
      background: var(--smoke);
      /* NEW: For confirm/cancel */
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* =======================================
       NEW: Toast / Alert Modal
       ======================================= */
    .toast-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      z-index: 2000; /* Higher than order modal */
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .toast-box {
      background: var(--paper);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      animation: modal-fade-in 0.2s ease-out;
      border-top: 5px solid var(--gold);
    }
    .toast-box h3 {
      font-weight: 900;
      font-size: 1.25rem;
      padding: 16px 16px 0 16px;
    }
    .toast-box p {
      padding: 8px 16px 16px 16px;
      color: var(--muted);
      font-weight: 700;
      line-height: 1.5;
    }
    .toast-footer {
      padding: 10px 16px;
      background: var(--smoke);
      text-align: right;
    }
    
    /* =======================================
       NEW: Item Added Toast
       ======================================= */
    .item-toast {
      position: fixed;
      bottom: 100px; /* Above mobile nav */
      left: 50%;
      transform: translateX(-50%);
      background: var(--coal-2);
      color: var(--paper);
      padding: 12px 20px;
      border-radius: 999px;
      font-weight: 700;
      z-index: 999;
      box-shadow: var(--shadow);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease, bottom 0.3s ease;
    }
    .item-toast.show {
      bottom: 110px;
      opacity: 1;
      visibility: visible;
    }


    /* =======================================
       Desktop & Tablet Media Queries
       ======================================= */
    @media(min-width:768px){
      /* Show desktop nav, hide mobile nav */
      .nav { display: grid; } /* Changed to grid */
      .nav-inner { width:min(1200px,95vw); margin-inline:auto; }
      .nav-mobile { display: none; }
      #nav-timer-mobile { display: none !important; } /* Hard hide mobile timer */

      /* Restore container widths */
      .container {
        width:min(1200px,95vw);
      }

      /* Restore layout for hero */
      .hero{
        min-height:82svh;
        display:grid;
        align-items:center;
        padding:clamp(18px,4vw,40px) 0;
      }
      .hero .grid{
        grid-template-columns:1.05fr 1fr;
        align-items: start; /* Match mobile */
      }
      .hero-card {
        min-height:auto; /* Match mobile */
      }
      .hero-services {
         grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); /* Restore desktop grid */
      }

      /* Restore layout for sections */
      .section {
        padding: clamp(18px,4vw,34px) 0; /* Restore desktop padding */
      }

      /* Make dock sticky again on desktop */
      .dock {
        display: block; /* Ensure it's visible */
        position:sticky;
        bottom:0;left:0;right:0;
      }
      
      /* Reset item toast position for desktop */
      .item-toast {
        bottom: 20px;
      }
      .item-toast.show {
        bottom: 30px;
      }
      
      .app-footer {
        padding-bottom: 16px; /* Reset on desktop */
      }
    }
      
    /* Responsive overrides for smaller layouts */
    /* FIX: Changed to 767px to prevent tablet overflow */
    @media(max-width:767px){
      #nav-timer-desktop { display: none; } /* Hide desktop timer */
      #nav-timer-mobile { display: block; } /* Show mobile timer */
      .hero { padding-top: 10px; } /* Reduce top padding since nav is gone */

      .row{grid-template-columns:1fr auto;grid-template-areas:"name price" "qty remove"}
      .row > div:nth-child(1){grid-area:name}
      .row > .qty{grid-area:qty}
      .row > div:nth-child(3){grid-area:price;justify-self:end}
      .row > button.remove{grid-area:remove;justify-self:end}
      
      /* This rule is now redundant due to the 520px rule, but harmless */
      /* .menu-grid{grid-template-columns:1fr} */
    }
    
  </style>
</head>
<body>

  <!-- 
    SVG Sprite Sheet 
    Define all icons here once
  -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <symbol id="svg-scooter" viewBox="0 0 24 24">
        <path d="M19.78 11.5c-.3 0-.58.05-.85.14L17.2 8H20V6h-3.72l-1.4-4H12v2h2.2l1.1 3H12c-2.76 0-5 2.24-5 5v1.43c-1.8.76-3 2.5-3 4.57 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.8-1.03-3.36-2.5-4.24V14h2.2l1.73 3H17v2h3.28l1.1-5H22v-2h-2.22zM9 20c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm8-6h-2.67l-1.73-3H9v-2c0-1.66 1.34-3 3-3h2.33l1.8 5.4c.17-.03.33-.06.5-.08.12-.01.23-.02.35-.02 1.66 0 3 1.34 3 3s-1.34 3-3 3c-.12 0-.23-.01-.35-.02-.17-.02-.33-.05-.5-.08L17 14z"/>
      </symbol>
      <symbol id="svg-burger" viewBox="0 0 20 20">
        <path d="M10 1c-4.418 0-8 2.239-8 5v3h16V6c0-2.761-3.582-5-8-5zM2 11v1.93c0 1.066.86 1.93 1.928 1.93h12.144C17.14 14.86 18 13.996 18 12.93V11H2zM4 16.028v-1.028h12v1.028A1.972 1.972 0 0114.028 18H5.972A1.972 1.972 0 014 16.028z"/>
      </symbol>
      <symbol id="svg-grocery" viewBox="0 0 20 20">
        <path d="M16 6v2h2l-1.5 9H5.5L4 8h2V6a4 4 0 118 0zM8 6a2 2 0 114 0v2H8V6zM6.49 10l.8 6h5.42l.8-6H6.49z"/>
      </symbol>
      <symbol id="svg-bottle" viewBox="0 0 20 20">
        <path d="M12 5V2a1 1 0 00-1-1H9a1 1 0 00-1 1v3H5a1 1 0 00-1 1v12a1 1 0 001 1h10a1 1 0 001-1V6a1 1 0 00-1-1h-3zM9 3h2v2H9V3zm6 14H5V7h10v10z"/>
        <path d="M7 10h2v4H7z"/>
      </symbol>
      <symbol id="svg-medicine" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2h-3V3a1 1 0 00-1-1H9zM5 6h10v10H5V6zm5 1a1 1 0 011 1v2h2a1 1 0 110 2h-2v2a1 1 0 11-2 0v-2H7a1 1 0 110-2h2V8a1 1 0 011-1z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-chevron" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-home" viewBox="0 0 20 20">
        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5V17a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
      </symbol>
      <symbol id="svg-store" viewBox="0 0 20 20">
        <path d="M2 2a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H3a1 1 0 01-1-1V2zm0 4v10a1 1 0 001 1h14a1 1 0 001-1V6H2zm3 2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1H6a1 1 0 01-1-1V8zm7 0a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2a1 1 0 01-1-1V8z"/>
      </symbol>
      <symbol id="svg-cart" viewBox="0 0 20 20">
        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.92 1.056l7.23.904A1 1 0 0013.8 5.48L16 3l-1.29 2.064A.998.998 0 0014.07 6H7.79l-.35-1.405a1 1 0 00-.922-1.055L3 3.42V1zM4.328 8l1.36 5.447A1.998 1.998 0 007.618 15h4.764a2 2 0 001.93-1.553L15.67 8H4.328zM7 17a1 1 0 110 2 1 1 0 010-2zm8 0a1 1 0 110 2 1 1 0 010-2z"/>
      </symbol>
      <symbol id="svg-location" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-user" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-phone" viewBox="0 0 20 20">
        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.058l-1.956 1.05a11.03 11.03 0 005.456 5.456l1.05-1.956a1 1 0 011.058-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C6.477 18 2 13.523 2 7V3z"/>
      </symbol>
      <symbol id="svg-address" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-notes" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm2 2a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 4a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
      </symbol>
      <symbol id="svg-enter" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd"/>
      </symbol>
      
      <!-- Social Icons -->
      <symbol id="svg-whatsapp" viewBox="0 0 24 24">
        <path d="M20.5 3.4A12 12 0 0 0 12 0 12 12 0 0 0 .5 19.8l.1.1 3.5 1 1-3.4-.1-.1a12 12 0 0 1 1.4-14 12 12 0 0 1 17.1 2.9 12 12 0 0 1 2.9 17.1A12 12 0 0 1 12 24h-.1a12 12 0 0 1-8.5-3.5l-.1-.1-3.8 1.1 1.1-3.8.1-.1A12 12 0 0 1 12 0a12 12 0 0 1 8.5 3.4zM12 21.8c3.2 0 6.2-1.2 8.5-3.5a10 10 0 0 0 2.9-8.5 10 10 0 0 0-3.5-8.5 10 10 0 0 0-8.5-3.5 10 10 0 0 0-8.5 3.5 10 10 0 0 0-3.5 8.5 10 10 0 0 0 3.5 8.5l.1.1 2.7-.8-.8 2.7-.1-.1a10 10 0 0 0 8.5 3.5zm5.5-6.9c-.3-.1-1.6-.8-1.9-.9-.3-.1-.5-.1-.7.1-.2.2-.7.8-.9 1-.1.1-.3.2-.5.1-.3-.1-1.1-.4-2.1-1.3-.8-.7-1.3-1.5-1.5-1.8-.1-.3 0-.5.1-.6.1-.1.2-.3.4-.4.1-.1.2-.2.2-.4.1-.2 0-.3-.1-.4-.1-.1-.7-1.6-.9-2.2-.2-.6-.4-.5-.5-.5h-.5c-.2 0-.4 0-.6.1-.2.1-.5.2-.8.5-.2.3-.8 1-.8 2.3 0 1.4 1 2.7 1.1 2.9.1.2 1.6 2.5 4 3.5.6.2 1 .4 1.4.5.6.2 1.1.1 1.5.1.5-.1 1.6-.7 1.9-1.3.2-.6.2-1.1.1-1.3-.1-.3-.3-.4-.5-.5z"/>
      </symbol>
      <symbol id="svg-facebook" viewBox="0 0 24 24">
        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm3 8h-1.5c-.7 0-1.5.4-1.5 1.5V11h3l-.5 3h-2.5v7h-3v-7H8v-3h2.5V9.5C10.5 7.1 12.1 6 15 6h1v2z"/>
      </symbol>
      <symbol id="svg-instagram" viewBox="0 0 24 24">
        <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.784.297-1.455.717-2.126 1.387C1.34 2.69 1.01 3.36.71 4.14.41 4.905.21 5.775.15 7.053.092 8.333.075 8.74.075 12s.015 3.667.072 4.947c.06 1.277.26 2.148.56 2.912.297.785.717 1.455 1.387 2.126 1.34 1.34 3.05 1.91 4.94 1.91s3.6-.57 4.94-1.91c.67-.67 1.09-1.34 1.387-2.126.3-.764.5-1.635.56-2.912.058-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.26-2.148-.56-2.912C21.99 3.36 21.66 2.69 21.36 2.02c-.67-.67-1.34-1.09-2.126-1.387-.764-.3-1.635-.5-2.912-.56C15.667.015 15.26 0 12 0zm0 2.16c3.203 0 3.585.012 4.85.07 1.17.055 1.805.248 2.227.415.562.217.96.477 1.382.896.42.42.68.82.896 1.382.167.422.36 1.057.413 2.227.058 1.265.07 1.646.07 4.85s-.012 3.585-.07 4.85c-.055 1.17-.248 1.805-.413 2.227-.217.562-.477.96-.896 1.382-.42.42-.82.68-1.382.896-.422.167-1.057.36-2.227.413-1.265.058-1.646.07-4.85.07s-3.585-.012-4.85-.07c-1.17-.055-1.805-.248-2.227-.413-.562-.217-.96-.477-1.382-.896-.42-.42-.68-.82-.896-1.382-.167-.422-.36-1.057-.413-2.227-.058-1.265-.07-1.646-.07-4.85s.012-3.585.07-4.85c.055-1.17.248-1.805.413-2.227.217-.562.477.96.896-1.382.42-.42.82-.68-1.382-.896.422-.167-1.057-.36-2.227-.413-1.265-.058-1.646-.07-4.85-.07zM12 6.162a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.88 1.44 1.44 0 000-2.88z"/>
      </symbol>
      <symbol id="svg-tiktok" viewBox="0 0 24 24">
        <path d="M21 4H3C1.9 4 1 4.9 1 6v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-4.1 11.1c-.6.2-1.2.3-1.9.3-1.6 0-3.1-.7-4.1-1.9v5.5H7V7h3.5v6.1c.3-.1.7-.2 1-.2 1.9 0 3.5 1.6 3.5 3.5 0 .5-.1 1-.3 1.4l.1.1 2.2 2.2h-3z"/>
      </symbol>
      <symbol id="svg-x" viewBox="0 0 24 24">
        <path d="M18.9 1.1l-6.3 7.2-5.9-7.2H1.1l7.3 8.9L1.1 23h5.6l6.9-8 6.4 8h5.6L12 12.4 18.9 1.1zM14.9 19.8L5.4 3.7H8l9.5 16.1h-2.6z"/>
      </symbol>
      
      <!-- NEW: Success Icon -->
      <symbol id="svg-success" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
      </symbol>
      
      <!-- NEW: Add to Cart Icon -->
      <symbol id="svg-add-cart" viewBox="0 0 20 20">
         <path d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-1 1v1a1 1 0 001 1h1v1a1 1 0 102 0v-1h4v1a1 1 0 102 0v-1h1a1 1 0 001-1V7a1 1 0 00-1-1h-1V6a4 4 0 00-4-4zm0 2a2 2 0 012 2v1H8V6a2 2 0 012-2zM4 11v6a2 2 0 002 2h8a2 2 0 002-2v-6H4z"/>
      </symbol>

    </defs>
  </svg>

  <!-- NAV (Desktop) -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="brand"><div class="logo"><svg class="icon"><use xlink:href="#svg-scooter" /></svg></div>We Deliver</div>
      
      <!-- NEW DESKTOP TIMER -->
      <div class="nav-timer" id="nav-timer-desktop">
        <span class="date-time" id="datetime-desktop">Loading date and time...</span>
        <span class="countdown" id="countdown-desktop">Loading countdown...</span>
      </div>
      <!-- END TIMER -->

      <div class="nav-links">
        <a href="#" class="link" data-nav="index">Home</a>
        <a href="#" class="link" data-nav="restaurants">Restaurants</a>
        <button class="button primary" data-nav="cart" id="nav-cart-btn">Cart (0)</button>
      </div>
    </div>
  </nav>

  <!-- HERO / INDEX -->
  <header id="view-index" class="container hero">
    <div class="grid">
      <!-- LEFT COLUMN: brand, slideshow, zones, actions, popular -->
      <div>
        <div class="hero-brand">
          <div class="hero-logo"><svg class="icon"><use xlink:href="#svg-scooter" /></svg></div>
          <h1 class="hero-title">We Deliver</h1>
        </div>
        
        <!-- NEW MOBILE TIMER -->
        <div class="nav-timer" id="nav-timer-mobile">
          <span class="date-time" id="datetime-mobile">Loading date and time...</span>
          <span class="countdown" id="countdown-mobile">Loading countdown...</span>
        </div>
        <!-- END MOBILE TIMER -->


        <!-- Real scooter slideshow + coal background -->
        <div class="hero-bg" style="margin-top: 12px;">
          <div class="ride-photos" aria-label="Real delivery scooters in action">
            <!-- UPDATED: Sarcastic Text -->
            <img src="https://placehold.co/1600x900/0B0E10/D4AF37?text=Hot+Food.+Cold+Stares." alt="Hot Food. Cold Stares." />
            <img src="https://placehold.co/1600x900/111418/D4AF37?text=We're+Faster+Than+Your+Excuses." alt="We're Faster Than Your Excuses." />
            <img src="https://placehold.co/1600x900/0B0E10/D4AF37?text=Don't+Cook.+Just+Order." alt="Don't Cook. Just Order." />
            <img src="https://placehold.co/1600x900/111418/D4AF37?text=Probably+Judging+Your+Order." alt="Probably Judging Your Order." />
            <div class="sticker">WE DELIVER</div>
          </div>
        </div>

        <!-- Zone selection (single method) -->
        <div class="zone-panel">
          <div class="caption-title">Choose your area</div>
          <div class="zones" id="quick-zones">
            <div class="pill" data-zone="Kwaguqa" role="button" tabindex="0" aria-pressed="false">Kwaguqa</div>
            <div class="pill" data-zone="Ackerville" role="button" tabindex="0" aria-pressed="false">Ackerville</div>
            <div class="pill" data-zone="Lynnville" role="button" tabindex="0" aria-pressed="false">Lynnville</div>
            <div class="pill" data-zone="Thusanang" role="button" tabindex="0" aria-pressed="false">Thusanang</div>
            <div class="pill" data-zone="Clewer" role="button" tabindex="0" aria-pressed="false">Clewer</div>
            <div class="pill" data-zone="Overline" role="button" tabindex="0" aria-pressed="false">Overline</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;justify-content:center">
            <!-- FIX: Added data-nav="restaurants" to this button -->
            <button class="button primary" id="hero-start" data-nav="restaurants">Start ordering</button>
            <button class="button" data-nav="restaurants" id="hero-browse-rest">Browse restaurants</button>
          </div>
        </div>

        <!-- Popular nearby shortcuts -->
        <div class="card" style="margin-top:12px">
          <div class="qtitle" style="font-weight:900">Popular nearby</div>
          <!-- FIX: Changed from flex to a responsive grid to prevent squashing/bad wrapping -->
          <div class="quick-row" id="quick-popular" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:10px; padding-top:8px">
            <!-- This content is now DYNAMICALLY generated by initIndex() -->
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: services grid -->
      <div>
        <!-- Operating Message -->
        <div class="operating-message" id="operating-message">
          <h3 id="operating-title">We're here for your deliveries!</h3>
          <p id="delivery-status">We are open for deliveries and orders during working hours and off-hours.</p>
          <div class="contact-info">
            <p><strong>Trading Hours:</strong></p>
            <p>Monday - Friday: 8:00 AM - 8:00 PM</p>
            <p>Saturday - Sunday: 9:00 AM - 7:00 PM</p>
            <p><strong>Contact Us:</strong></p>
            <!-- Social Media Buttons -->
            <div class="social-buttons">
              <a href="tel:+27794573805" class="social-btn call" aria-label="Call us">
                <svg class="icon"><use xlink:href="#svg-phone" /></svg>
              </a>
              <a href="https://wa.me/27794573805" target="_blank" class="social-btn wa" aria-label="WhatsApp us">
                <svg class="icon"><use xlink:href="#svg-whatsapp" /></svg>
              </a>
              <a href="#" class="social-btn fb" aria-label="Facebook">
                <svg class="icon"><use xlink:href="#svg-facebook" /></svg>
              </a>
              <a href="#" class="social-btn ig" aria-label="Instagram">
                <svg class="icon"><use xlink:href="#svg-instagram" /></svg>
              </a>
              <a href="#" class="social-btn tk" aria-label="TikTok">
                <svg class="icon"><use xlink:href="#svg-tiktok" /></svg>
              </a>
              <a href="#" class="social-btn x" aria-label="X (Twitter)">
                <svg class="icon"><use xlink:href="#svg-x" /></svg>
              </a>
            </div>
          </div>
        </div>
      
        <div class="hero-card">
          <div class="hero-services" aria-label="Our services">
            <div class="svc"><div class="s-ico"><svg class="icon icon-fill"><use xlink:href="#svg-burger" /></svg></div><div class="s-name">Food</div><div class="s-desc">Restaurants & takeaways</div></div>
            <div class="svc"><div class="s-ico"><svg class="icon icon-fill"><use xlink:href="#svg-grocery" /></svg></div><div class="s-name">Groceries</div><div class="s-desc">Quick household runs</div></div>
            <div class="svc"><div class="s-ico"><svg class="icon icon-fill"><use xlink:href="#svg-bottle" /></svg></div><div class="s-name">Liquor</div><div class="s-desc">Local bottle stores</div></div>
            <div class="svc"><div class="s-ico"><svg class="icon icon-fill"><use xlink:href="#svg-medicine" /></svg></div><div class="s-name">Medicine</div><div class="s-desc">Pharmacy pick‑ups</div></div>
            <!-- FIX: Cleaned up inline style, removed redundant min-width -->
            <div class="svc" style="grid-column: 1 / -1;"><div class="s-ico"><svg class="icon icon-fill"><use xlink:href="#svg-scooter" /></svg></div><div class="s-name">Parcels</div><div class="s-desc">Kasi‑to‑kasi courier</div></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- RESTAURANTS -->
  <main id="view-restaurants" class="container section" style="display:none">
    <div class="card" style="margin-bottom:14px;display:flex;align-items:end;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <div class="muted">DELIVERING TO</div>
        <h2 id="zone-label">Your Zone</h2>
      </div>
      <button class="button" data-nav="index" id="change-area">Change area</button>
    </div>
    <div class="field search-field" style="margin-bottom:12px;">
      <div><svg class="icon"><use xlink:href="#svg-search" /></svg></div>
      <input id="rest-search" type="text" placeholder="Search restaurants..." aria-label="Search restaurants" />
      <div><svg class="icon"><use xlink:href="#svg-enter" /></svg></div>
    </div>
    <div id="restaurant-list">
      <!-- This content is now DYNAMICALLY generated by initRestaurants() -->
    </div>
    
    <!-- NEW: "Can't find it?" card -->
    <div class="whatsapp-card" id="whatsapp-fallback-card" style="display: none;">
      <h3>Can't find what you want?</h3>
      <p>No problem. Send us a custom order on WhatsApp and we'll see what we can do.</p>
      <button class="button whatsapp" id="custom-wa-order-btn">
        <svg class="icon" style="font-size: 20px;"><use xlink:href="#svg-whatsapp" /></svg>
        <span>Order on WhatsApp</span>
      </button>
    </div>

  </main>

  <!-- MENU -->
  <section id="view-menu" class="container section" style="display:none">
    <div class="menu-banner" id="menu-banner"></div>
    <div class="card" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h2 id="menu-title">Restaurant</h2>
      <!-- FIX: Added flex-wrap: wrap to this container -->
      <div style="display:flex;gap:12px;align-items:center;flex:1;justify-content:flex-end; flex-wrap: wrap;">
        <div class="field search-field" style="max-width:320px;">
          <div><svg class="icon"><use xlink:href="#svg-search" /></svg></div>
          <input id="menu-search" type="text" placeholder="Search this menu..." aria-label="Search menu" />
          <div><svg class="icon"><use xlink:href="#svg-enter" /></svg></div>
        </div>
        <button class="button primary" id="view-cart-btn" data-nav="cart">View Cart (0)</button>
      </div>
    </div>
    <div id="menu-list" class="menu-grid" style="margin-top:12px;"></div>
    <div style="margin-top:12px"><button class="button" data-nav="restaurants">‹ Back</button></div>
  </section>

  <!-- CART -->
  <section id="view-cart" class="container section" style="display:none">
    <h2>Your Order</h2>
    <div class="cart" style="margin-top:10px">
      <div id="cart-items-container"></div>
      <div class="total"><div>Total</div><div id="cart-total-price">R0.00</div></div>
    </div>

    <form id="delivery-form" class="card" style="margin-top:12px">
      <h3 style="margin-bottom:8px">Delivery Details</h3>
      <div class="grid-auto" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
        <div class="field"><div><svg class="icon"><use xlink:href="#svg-user" /></svg></div><input id="df-name" type="text" placeholder="Full name" required /></div>
        <div class="field"><div><svg class="icon"><use xlink:href="#svg-phone" /></svg></div><input id="df-phone" type="tel" placeholder="Phone (e.g., 0812345678)" pattern="^0\d{9}$" title="South African numbers start with 0 and have 10 digits" required /></div>
        <div class="field" style="grid-column:1/-1"><div><svg class="icon"><use xlink:href="#svg-address" /></svg></div><input id="df-address" type="text" placeholder="Delivery address" required /></div>
        <div class="field" style="grid-column:1/-1"><div><svg class="icon"><use xlink:href="#svg-notes" /></svg></div><textarea id="df-notes" placeholder="Driver instructions (optional)"></textarea></div>
      </div>
    </form>

    <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
      <button class="button whatsapp" id="place-order">Order via WhatsApp</button>
      <button class="button" data-nav="restaurants">‹ Back</button>
    </div>
    
    <!-- REMOVED OLD PREVIEW DIV -->
    
  </section>
  
  <!-- NEW: Order Success Page -->
  <section id="view-success" class="container section" style="display:none; text-align: center;">
    <div class="success-icon">
      <svg class="icon"><use xlink:href="#svg-success" /></svg>
    </div>
    <h2 style="font-weight: 900; font-size: 1.8rem; margin-bottom: 8px;">Order Sent! (Nice.)</h2>
    <p class="muted" style="font-size: 1.1rem; max-width: 600px; margin: auto;">
      We've got your order. Now for the fun part: payment.
      Once we confirm payment, we'll start bugging the driver.
    </p>

    <div class="payment-options">
      <div class="payment-method">
        <h3>EFT (Bank Transfer)</h3>
        <p><strong>Bank:</strong> FNB</p>
        <p><strong>Account:</strong> 1234567890</p>
        <p><strong>Branch:</strong> 250655</p>
        <p><strong>Reference:</strong> Your Order No.</p>
      </div>
      
      <div class="payment-method">
        <h3>eWallet</h3>
        <p>Send your eWallet payment to:</p>
        <p><strong>079 457 3805</strong></p>
        <p><strong>Reference:</strong> Your Order No.</p>
      </div>
      
      <div class="payment-method" style="grid-column: 1 / -1;">
        <h3>Cash on Delivery</h3>
        <p>Please have the <strong>exact amount</strong> ready. Our drivers are drivers, not walking ATMs.</p>
      </div>
    </div>
    
    <button class="button primary" data-nav="index" style="margin-top: 24px;">‹ Back to Home</button>
    
  </section>

  <!-- Bottom progress dock (Now static on mobile, controlled by JS) -->
  <div class="dock" id="progress-dock">
    <div class="dock-inner">
      <div class="dot active" id="step-area"><div class="b"><svg class="icon"><use xlink:href="#svg-location" /></svg></div><div>Area</div></div>
      <div class="dot" id="step-rest"><div class="b"><svg class="icon"><use xlink:href="#svg-store" /></svg></div><div>Restaurants</div></div>
      <div class="dot" id="step-menu"><div class="b"><svg class="icon"><use xlink:href="#svg-menu" /></svg></div><div>Menu</div></div>
      <div class="dot" id="step-cart"><div class="b"><svg class="icon"><use xlink:href="#svg-cart" /></svg></div><div>Cart</div></div>
    </div>
  </div>

  <!-- NEW: App Footer -->
  <footer class="app-footer">
    © 2025 We Deliver (Kasi Play Phase 1) &nbsp;•&nbsp; All Rights Reserved
    <br>
    <strong>Version 1.0.0 (Pitch Demo)</strong>
    <!-- NEW: Dark Humor Disclaimer -->
    <p style="margin-top: 8px; font-size: 0.75rem;">
      *Disclaimer: Our humor is dark. Our deliveries are fast. Deal with it.*
    </p>
  </footer>
  
  <!-- NAV (Mobile - Sticky) -->
  <nav class="nav-mobile">
    <a href="#" class="n-link active" data-nav="index" aria-label="Home">
      <svg class="icon"><use xlink:href="#svg-home" /></svg>
      <span>Home</span>
    </a>
    <a href="#" class="n-link" data-nav="restaurants" aria-label="Restaurants">
      <svg class="icon"><use xlink:href="#svg-store" /></svg>
      <span>Restaurants</span>
    </a>
    <a href="#" class="n-link cart-link" data-nav="cart" aria-label="Cart">
      <svg class="icon"><use xlink:href="#svg-cart" /></svg>
      <span>Cart</span>
      <span class="badge" id="mobile-cart-badge" style="display: none;">0</span>
    </a>
  </nav>

  <!-- Order Preview Modal -->
  <div class="modal-overlay" id="order-preview-modal">
    <div class="modal-box">
      <div class="modal-header">
        <h2>Confirm Your Order</h2>
        <button class="modal-close" id="modal-close-btn" aria-label="Close">×</button>
      </div>
      <div class="modal-content">
        
        <div class="order-meta">
          <p>Order No: <span id="modal-order-number">WD00000</span></p>
          <p>Date: <span id="modal-order-date">--/--/----</span></p>
          <p>Time: <span id="modal-order-time">--:--</span></p>
        </div>

        <div class="preview" id="modal-preview-output">
          <!-- Order text will be injected here -->
        </div>

      </div>
      <div class="modal-footer" id="order-modal-footer">
        <!-- UPDATED: Added Cancel button -->
        <button class="button" id="modal-cancel-btn">Cancel</button>
        <button class="button whatsapp" id="modal-send-wa" data-link="">Send to We Deliver</button>
      </div>
      
      <!-- NEW: Confirmation step -->
      <div class="modal-footer" id="confirm-wa-footer" style="display: none;">
        <button class="button" id="confirm-wa-cancel">Cancel</button>
        <button class="button whatsapp" id="confirm-wa-open">
          <svg class="icon" style="font-size: 20px;"><use xlink:href="#svg-whatsapp" /></svg>
          <span>Open WhatsApp</span>
        </button>
      </div>

    </div>
  </div>

  <!-- NEW: Sarcastic Toast / Alert Modal -->
  <div class="toast-overlay" id="toast-modal">
    <div class="toast-box">
      <h3 id="toast-title">Something's Missing...</h3>
      <p id="toast-message">You forgot to tell us some things.</p>
      <div class="toast-footer">
        <button class="button primary" id="toast-close-btn">Okay, I get it</button>
      </div>
    </div>
  </div>
  
  <!-- NEW: Item Added Toast -->
  <div class="item-toast" id="item-added-toast">
    <svg class="icon" style="font-size: 20px; margin-right: 8px;"><use xlink:href="#svg-add-cart" /></svg>
    <span id="item-added-toast-text">Item added to cart!</span>
  </div>


  <script>
    // ===== Config =====
    const WHATSAPP_NUMBER = '27794573805'; // TEMP: client test route (provide full 10‑digit SA number to auto-convert)
    const DEMO_PREVIEW = true;            // preview before opening WA
    const WA_QUERY_OVERRIDE = new URLSearchParams(location.search).get('wanum');
    function toIntlZa(n){
      n = (n||'').replace(/[^0-9]/g,'');
      if(n.startsWith('0') && n.length===10) return '27'+n.slice(1);
      if(n.startsWith('27')) return n;
      return n; // fallback (will still open WA, but best to use full number)
    }
    function getWaNumber(){
      const raw = localStorage.getItem('weDeliver_test_wa') || WA_QUERY_OVERRIDE || WHATSAPP_NUMBER;
      return toIntlZa(raw);
    }
    
    // Function to get incrementing Order Number
    function getOrderNumber() {
      let currentNum = parseInt(localStorage.getItem('weDeliverOrderNum') || '0', 10);
      currentNum++;
      localStorage.setItem('weDeliverOrderNum', currentNum);
      return 'WD' + currentNum.toString().padStart(5, '0');
    }
    
    // NEW: Function to show sarcastic toast modal
    function showToast(title, message) {
      $('#toast-title').textContent = title;
      $('#toast-message').textContent = message;
      $('#toast-modal').style.display = 'flex';
    }
    
    // NEW: Function to show "Item Added" toast
    let itemToastTimer;
    function showItemAddedToast(itemName) {
      const toast = $('#item-added-toast');
      $('#item-added-toast-text').textContent = `${itemName}`;
      
      // Clear any existing timer
      if (itemToastTimer) {
        clearTimeout(itemToastTimer);
      }
      
      toast.classList.add('show');
      
      // Hide after 3 seconds
      itemToastTimer = setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }


    // ===== NEW: Master Restaurant Database =====
    const ALL_RESTAURANTS = {
      // --- Kwaguqa ---
      'Kasi Kitchen': {
        zones: ['Kwaguqa'],
        tags: 'African • Quick',
        delivery: 'R20',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Kasi+Kitchen',
        menu: [
          { name: 'Kasi Burger', price: 45.00, desc: 'Our famous local burger.' },
          { name: 'Grilled Fish', price: 88.00, desc: 'Fresh grilled fish with spices.' },
          { name: 'Vegetable Curry', price: 55.00, desc: 'Hearty vegetable curry.' }
        ]
      },
      'Spoti\'s Grill': {
        zones: ['Kwaguqa', 'Lynnville'],
        tags: 'Shisanyama • Local',
        delivery: 'R15',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Spoti%27s+Grill',
        menu: [
          { name: 'Full Chicken', price: 120.00, desc: 'Flame-grilled peri-peri.' },
          { name: 'Wors Roll', price: 30.00, desc: 'Local boerewors.' },
          { name: 'Pap & Gravy', price: 25.00, desc: 'A staple side.' }
        ]
      },
      // --- Ackerville ---
      'Savory Bites': {
        zones: ['Ackerville'],
        tags: 'Fast Food',
        delivery: 'R15',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Savory+Bites',
        menu: [
          { name: 'Classic Chips', price: 25.00, desc: 'Crispy golden fries.' },
          { name: 'Chicken Wrap', price: 60.00, desc: 'Grilled chicken with salad.' },
          { name: 'Double Cheese Burger', price: 75.00, desc: 'Extra cheesy goodness.' }
        ]
      },
      'The Shisanyama Spot': {
        zones: ['Ackerville'],
        tags: 'Grill • Shisanyama',
        delivery: 'R20',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Shisanyama',
        menu: [
          { name: 'Beef Brisket (200g)', price: 80.00, desc: 'Slow-cooked and tender.' },
          { name: 'Chakalaka', price: 20.00, desc: 'Spicy vegetable relish.' },
          { name: 'Garlic Roll', price: 15.00, desc: 'Toasted with garlic butter.' }
        ]
      },
      // --- Lynnville ---
      "Mama's Eats": {
        zones: ['Lynnville'],
        tags: 'Hearty • Home-cooked',
        delivery: 'R20',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Mama%27s+Eats',
        menu: [
          { name: 'Pap & Chicken', price: 65.00, desc: 'Homestyle favourite.' },
          { name: 'Beef Stew', price: 79.00, desc: 'Slow-cooked, rich gravy.' },
          { name: 'Chakalaka Side', price: 18.00, desc: 'Spicy veggie relish.' }
        ]
      },
      'Nandos Lynnville': {
        zones: ['Lynnville', 'Ackerville'],
        tags: 'Chicken • Peri-Peri',
        delivery: 'R15',
        img: 'https://placehold.co/200x150/B60000/FFFFFF?text=Nandos',
        menu: [
          { name: '1/4 Chicken & Roll', price: 59.90, desc: 'A classic fave.' },
          { name: 'Full Chicken', price: 189.90, desc: 'For the whole family.' },
          { name: 'Peri-Peri Chips (L)', price: 35.00, desc: 'With that famous spice.' }
        ]
      },
      // --- Thusanang ---
      'Thusanang Fisheries': {
        zones: ['Thusanang'],
        tags: 'Fish & Chips',
        delivery: 'R10',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Fisheries',
        menu: [
          { name: 'Hake & Chips', price: 50.00, desc: 'Classic fried hake.' },
          { name: 'Calamari (Small)', price: 40.00, desc: 'Fried calamari rings.' },
          { name: 'Russian & Chips', price: 35.00, desc: 'A local classic.' }
        ]
      },
      'Pizza Perfect': {
        zones: ['Thusanang', 'Clewer'],
        tags: 'Pizza • Italian',
        delivery: 'R20',
        img: 'https://placehold.co/200x150/006423/FFFFFF?text=Pizza+Perfect',
        menu: [
          { name: 'Regina Pizza (L)', price: 110.00, desc: 'Ham and mushroom.' },
          { name: 'Four Seasons (L)', price: 130.00, desc: 'A bit of everything.' },
          { name: 'Garlic Bread', price: 30.00, desc: 'Cheesy garlic bread.' }
        ]
      },
      // --- Clewer ---
      'Clewer Fast Foods': {
        zones: ['Clewer'],
        tags: 'Burgers • Quick',
        delivery: 'R10',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Clewer+Foods',
        menu: [
          { name: 'Dagwood Burger', price: 65.00, desc: 'With egg, bacon, cheese.' },
          { name: 'Toasted Cheese', price: 25.00, desc: 'Simple and good.' },
          { name: 'Milkshake (Large)', price: 40.00, desc: 'Chocolate, Lime, or Banana.' }
        ]
      },
      'KFC Clewer': {
        zones: ['Clewer', 'Overline'],
        tags: 'Chicken • Burgers',
        delivery: 'R15',
        img: 'https://placehold.co/200x150/A3080C/FFFFFF?text=KFC',
        menu: [
          { name: 'Streetwise 2', price: 42.90, desc: '2 pieces, small chips.' },
          { name: 'Zinger Burger', price: 49.90, desc: 'Spicy zinger fillet.' },
          { name: 'Family Bucket (9pc)', price: 219.90, desc: '9 pieces and large chips.' }
        ]
      },
      // --- Overline ---
      'Overline Pies': {
        zones: ['Overline'],
        tags: 'Pies • Bakery',
        delivery: 'R10',
        img: 'https://placehold.co/200x150/0B0E10/F2D36B?text=Pies',
        menu: [
          { name: 'Pepper Steak Pie', price: 28.00, desc: 'Hot and peppery.' },
          { name: 'Chicken Pie', price: 26.00, desc: 'Creamy chicken filling.' },
          { name: 'Sausage Roll', price: 18.00, desc: 'A classic snack.' }
        ]
      },
      'Debonairs Pizza': {
        zones: ['Overline', 'Kwaguqa'],
        tags: 'Pizza',
        delivery: 'R15',
        img: 'https://placehold.co/200x150/004B35/FFFFFF?text=Debonairs',
        menu: [
          { name: 'Triple Decker (L)', price: 199.90, desc: 'Three layers of flavour.' },
          { name: 'Something Meaty (L)', price: 139.90, desc: 'For the meat lovers.' },
          { name: 'Crammed Crust', price: 25.00, desc: 'Add to any large pizza.' }
        ]
      },
    };

    // Helper to get restaurants for a specific zone
    function getRestaurantsByZone(zone) {
      if (!zone) return [];
      
      return Object.entries(ALL_RESTAURANTS)
        .filter(([name, data]) => data.zones.includes(zone))
        .map(([name, data]) => ({ name, ...data }));
    }


    // ===== Helpers & State =====
    // let CURRENT_RESTAURANT = null; // This is now set by cartState
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    
    // NEW: Updated Cart logic to store restaurant
    const getCartState = () => {
      try { 
        return JSON.parse(localStorage.getItem('weDeliverCartState')) || { items: [], restaurant: null }; 
      } catch { 
        return { items: [], restaurant: null }; 
      }
    };
    const saveCartState = (state) => {
      localStorage.setItem('weDeliverCartState', JSON.stringify(state));
      updateCartCount(); // Update count anytime cart is saved
    };
    const clearCart = () => {
      saveCartState({ items: [], restaurant: null });
    };


    // ===== Master Time Updater =====
    // This one function runs every second to update all time-related UI
    let IS_OPEN_GLOBALLY = false; // NEW: Global state
    function masterTimeUpdater() {
      const now = new Date();
      
      // --- Time & Date Formatting ---
      // Use "Africa/Johannesburg" to ensure SAST (UTC+2)
      const optionsDate = { timeZone: 'Africa/Johannesburg', weekday: 'long', day: 'numeric', month: 'long' };
      const optionsTime = { timeZone: 'Africa/Johannesburg', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
      
      const dateString = now.toLocaleDateString('en-ZA', optionsDate);
      const timeString = now.toLocaleTimeString('en-US', optionsTime);

      // --- Open/Closed Logic ---
      let isOpen = false; // Default to closed
      const day = now.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
      const hour = now.getHours();
      
      let openHour, closeHour;

      if (day >= 1 && day <= 5) { // Monday to Friday
        openHour = 8;
        closeHour = 20; // 8:00 PM
      } else { // Saturday & Sunday (day === 0 || day === 6)
        openHour = 9;
        closeHour = 19; // 7:00 PM
      }

      if (hour >= openHour && hour < closeHour) {
        isOpen = true;
      }
      
      // --- FOR DEMO: Uncomment next line to force "open" state ---
      isOpen = true; 
      
      IS_OPEN_GLOBALLY = isOpen; // Update global state

      // 1. Update Operating Message Card with Sarcasm
      const deliveryStatusElement = $('#delivery-status');
      const heroTitleElement = $('#operating-title');
      if (heroTitleElement && deliveryStatusElement) {
        if (isOpen) {
          // NANDO'S STYLE OPEN MESSAGE:
          heroTitleElement.textContent = "We're Open! (Finally.)";
          deliveryStatusElement.textContent = "Your 'I'm too lazy to cook' emergency service is standing by. Order now before we change our minds.";
        } else {
          // NANDO'S STYLE CLOSED MESSAGE:
          heroTitleElement.textContent = "We're Closed. (Obviously.)";
          deliveryStatusElement.textContent = "You're late. We're probably sleeping. Try again tomorrow when we feel like it.";
        }
      }

      // 2. Update Buttons
      const heroStartButton = $('#hero-start');
      const browseRestaurantsButton = $('#hero-browse-rest');
      if (heroStartButton) {
        heroStartButton.disabled = !isOpen;
        heroStartButton.classList.toggle('disabled', !isOpen);
      }
      if (browseRestaurantsButton) {
        browseRestaurantsButton.disabled = !isOpen;
        browseRestaurantsButton.classList.toggle('disabled', !isOpen);
      }
      
      // 3. Disable Popular Nearby Cards
      $$('#quick-popular .rcard').forEach(card => {
        card.classList.toggle('disabled', !isOpen);
      });
      
      // 4. Disable Mobile Nav Links
      $$('.nav-mobile .n-link[data-nav="restaurants"], .nav-mobile .n-link[data-nav="cart"]').forEach(link => {
        link.classList.toggle('disabled', !isOpen);
      });
      
      // 5. Disable "Order on WhatsApp" button
      const customWAButton = $('#custom-wa-order-btn');
      if (customWAButton) {
        customWAButton.disabled = !isOpen;
        customWAButton.classList.toggle('disabled', !isOpen);
      }


      // 6. Calculate and Update Countdown Timers
      let nextEventTime = new Date(now);
      nextEventTime.setMilliseconds(0);
      let countdownMessage = "";
      let countdownClass = "";

      if (isOpen) {
        // Countdown to closing
        nextEventTime.setHours(closeHour, 0, 0);
        countdownMessage = "Closes in: ";
        countdownClass = "open";
      } else {
        // Countdown to opening
        countdownClass = "closed";
        if (hour < openHour) {
          // Still today, just not open yet
          nextEventTime.setHours(openHour, 0, 0);
          countdownMessage = "Opens in: ";
        } else {
          // Closed for the day, countdown to tomorrow
          nextEventTime.setDate(now.getDate() + 1);
          // Check if tomorrow is weekday or weekend for correct opening hour
          const nextDay = nextEventTime.getDay();
          if (nextDay >= 1 && nextDay <= 5) { // Weekday
            nextEventTime.setHours(8, 0, 0);
          } else { // Weekend
            nextEventTime.setHours(9, 0, 0);
          }
          countdownMessage = "Opens in: ";
        }
      }

      const diff = nextEventTime - now; // Diff in milliseconds
      const h = Math.floor(diff / (1000 * 60 * 60));
      const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const s = Math.floor((diff % (1000 * 60)) / 1000);
      
      // Pad with zeros
      const formattedCountdown = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

      // 7. Update DOM for timers
      const dateTimeString = `${dateString} | ${timeString}`;
      const fullCountdownString = `${countdownMessage} ${formattedCountdown}`;
      
      const dtDesktop = $('#datetime-desktop');
      const cdDesktop = $('#countdown-desktop');
      if (dtDesktop) dtDesktop.textContent = dateTimeString;
      if (cdDesktop) {
        cdDesktop.textContent = fullCountdownString;
        cdDesktop.className = `countdown ${countdownClass}`;
      }

      const dtMobile = $('#datetime-mobile');
      const cdMobile = $('#countdown-mobile');
      if (dtMobile) dtMobile.textContent = dateTimeString;
      if (cdMobile) {
        cdMobile.textContent = fullCountdownString;
        cdMobile.className = `countdown ${countdownClass}`;
      }
    }


    function show(id){
      // Hide all views
      ['index','restaurants','menu','cart','success'].forEach(v=> $('#view-'+v).style.display = 'none');
      // Show the target view
      const view = $('#view-'+id);
      if (view) view.style.display = 'block';

      // Show/Hide progress dock
      const dock = $('#progress-dock');
      if (dock) dock.style.display = (id === 'index' || id === 'success') ? 'none' : 'block';

      // Update progress dock steps
      step(id);
      
      // Update active state for mobile nav
      $$('.nav-mobile .n-link').forEach(n => {
        n.classList.toggle('active', n.dataset.nav === id);
      });
      // Handle "success" page (show "index" as active)
      if (id === 'success') {
        const homeNav = $('.nav-mobile .n-link[data-nav="index"]');
        if (homeNav) homeNav.classList.add('active');
      }

      // Run view-specific logic
      if(id==='restaurants') initRestaurants();
      if(id==='cart') renderCart();
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    function step(v){
      const map={index:'#step-area',restaurants:'#step-rest',menu:'#step-menu',cart:'#step-cart', success: '#step-cart'};
      ['#step-area','#step-rest','#step-menu','#step-cart'].forEach(s=> $(s).classList.remove('active'));
      if(map[v]) $(map[v]).classList.add('active');
    }

    function updateCartCount(){
      const cartState = getCartState();
      const count = cartState.items.reduce((n,i)=>n+i.qty,0);
      
      // Desktop Nav Button
      const nbtn=$('#nav-cart-btn'); 
      if(nbtn) nbtn.textContent = `Cart (${count})`;
      
      // Menu View Button
      const btn=$('#view-cart-btn'); 
      if(btn) btn.textContent = `View Cart (${count})`;
      
      // Mobile Nav Badge
      const badge = $('#mobile-cart-badge');
      if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'block' : 'none';
      }
    }
    
    // NEW: Function to render popular restaurants based on zone
    function renderPopularRestaurants(zone) {
      const popularContainer = $('#quick-popular');
      if (!popularContainer) return;

      popularContainer.innerHTML = ''; // Clear old ones
      
      // NEW: Check if zone is selected
      if (!zone) {
        popularContainer.innerHTML = `<p class="muted" style="padding: 10px;">Please select your area to see popular spots.</p>`;
        return;
      }
      
      const popularRests = getRestaurantsByZone(zone).slice(0, 3); // Get first 3

      if (popularRests.length === 0) {
        popularContainer.innerHTML = `<p class="muted" style="padding: 10px;">No popular restaurants found for ${zone}.</p>`;
        return;
      }

      popularRests.forEach(rest => {
        const card = document.createElement('div');
        card.className = 'rcard';
        card.dataset.restaurant = rest.name;
        card.tabIndex = 0;
        card.role = 'button';
        card.innerHTML = `
          <div class="ph" style="background-image:url('${rest.img}')"></div>
          <div>
            <h4>${rest.name}</h4>
            <div class="small">${rest.tags}</div>
          </div>
        `;
        // Add event listener
        card.addEventListener('click', (e) => {
          // Check if card is disabled
          if (card.classList.contains('disabled')) {
            e.stopPropagation(); // Stop click
            e.preventDefault();
            showToast("We're Closed!", "Our drivers are sleeping. (Promise!). Check back during trading hours.");
            return;
          }
          // This check is redundant now but good for safety
          if(!localStorage.getItem('weDeliverZone')){ 
            e.stopPropagation();
            e.preventDefault();
            showToast("Where To?", "We need to know your area before we can show you popular spots. Pick one!");
            document.querySelector('.zone-panel')?.scrollIntoView({behavior:'smooth',block:'start'}); 
            return; 
          }
          openMenu(rest.name);
        });
        popularContainer.appendChild(card);
      });
      
      // Re-apply disabled state if app is closed
      if (!IS_OPEN_GLOBALLY) {
        $$('#quick-popular .rcard').forEach(card => card.classList.add('disabled'));
      }
    }


    // ----- Index -----
    function initIndex(){
      const stored = localStorage.getItem('weDeliverZone');
      
      // NEW: Only auto-select if a zone was previously stored
      if(stored){
        $$('#quick-zones .pill').forEach(x=>{
          const isActive = x.dataset.zone===stored;
          x.classList.toggle('active', isActive);
          x.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }
      
      // NEW: Render popular restaurants on init
      renderPopularRestaurants(stored); // This will show "Please select" message if stored is null
      
      // The #hero-start button is now handled by the main [data-nav] listener
      // The #hero-browse-rest button is also handled by the main [data-nav] listener

      $$('#quick-zones .pill').forEach(p=>{
        const select = ()=>{
          const newZone = p.dataset.zone;
          localStorage.setItem('weDeliverZone', newZone);
          $$('#quick-zones .pill').forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-pressed','false'); });
          p.classList.add('active'); p.setAttribute('aria-pressed','true');
          
          // NEW: Re-render popular restaurants on zone change
          renderPopularRestaurants(newZone);
        };
        p.addEventListener('click', select);
        p.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); select(); }});
      });
      
      // Don't call updateOperatingMessage, masterTimeUpdater handles it
    }

    // ----- Restaurants -----
    function initRestaurants(){
      const zone = localStorage.getItem('weDeliverZone')||'Your Zone';
      $('#zone-label').textContent = zone;
      
      const listContainer = $('#restaurant-list');
      const fallbackCard = $('#whatsapp-fallback-card');
      listContainer.innerHTML = ''; // Clear old list
      
      const restaurants = getRestaurantsByZone(zone);
      
      // NEW: Show/hide fallback card
      if (restaurants.length === 0) {
        listContainer.innerHTML = `<p class="muted" style="padding: 16px; text-align: center;">Sorry, no restaurants found for ${zone}. Try another area!</p>`;
        fallbackCard.style.display = 'block'; // Show fallback
      } else {
        fallbackCard.style.display = 'none'; // Hide fallback
      }
      
      restaurants.forEach(rest => {
        const article = document.createElement('article');
        article.className = 'rest';
        article.dataset.restaurant = rest.name;
        article.innerHTML = `
          <div class="ph" style="background-image:url('${rest.img}')"></div>
          <div>
            <h3>${rest.name}</h3>
            <div class="muted">${rest.tags} • ${rest.delivery} delivery</div>
          </div>
          <div><svg class="icon"><use xlink:href="#svg-chevron" /></svg></div>
        `;
        article.onclick = () => openMenu(rest.name);
        listContainer.appendChild(article);
      });

      const rs=$('#rest-search');
      if(rs){ 
        rs.value = ''; // Clear search on load
        rs.oninput = ()=>{
          const q=rs.value.trim().toLowerCase();
          let visibleCount = 0;
          $$('#restaurant-list .rest').forEach(card=>{
            const name=card.querySelector('h3').textContent.toLowerCase();
            const isVisible = name.includes(q);
            card.style.display = isVisible ? 'grid':'none';
            if (isVisible) visibleCount++;
          });
          
          // NEW: Show/hide fallback card based on search
          if (visibleCount === 0 && restaurants.length > 0) {
            fallbackCard.style.display = 'block'; // Show if search finds nothing
          } else if (restaurants.length > 0) {
            fallbackCard.style.display = 'none'; // Hide if search finds something
          }
          // If restaurants.length is 0, the card is already visible from the logic above
        }
      }
    }
    
    // NEW: Handle "Order on WhatsApp" button
    $('#custom-wa-order-btn').addEventListener('click', () => {
      // This button is already disabled by masterTimeUpdater if closed
      const zone = localStorage.getItem('weDeliverZone') || 'Unspecified Zone';
      const msg = `*WE DELIVER - CUSTOM ORDER*\n\n*Zone:* ${zone}\n\nHi, I can't find what I'm looking for in the app. I'd like to place a custom order. Please let me know what you need.`;
      const waNumber = getWaNumber();
      const link = `https://wa.me/${waNumber}?text=${encodeURIComponent(msg)}`;
      
      // Use the popup function
      openWhatsAppPopup(link);
    });

    // ----- Menu -----
    function openMenu(name){
      const restData = ALL_RESTAURANTS[name];
      if (!restData) {
        console.error(`No data found for restaurant: ${name}`);
        showToast("Error", "Could not find restaurant data.");
        return;
      }

      $('#menu-title').textContent = name;
      const banner=$('#menu-banner');
      const img = restData.img.replace('200x150', '1200x600'); // Get larger banner image
      
      if(banner){ banner.style.backgroundImage = `linear-gradient(135deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 100%), url('${img}')`; banner.style.backgroundSize='cover'; banner.style.backgroundPosition='center'; }

      const list=$('#menu-list'); list.innerHTML='';
      
      const menuItems = restData.menu || [];
      
      if (menuItems.length === 0) {
        list.innerHTML = `<p class="muted" style="padding: 16px; text-align: center;">This restaurant doesn't have a menu online yet. Check back soon!</p>`;
      }
      
      menuItems.forEach(it=>{
        const el=document.createElement('div');
        el.className='menu-item';
        // FIX: Escape apostrophes in data-restaurant attribute
        const escapedName = name.replace(/'/g, "&apos;");
        el.innerHTML=`<h3>${it.name}</h3><div class='muted'>${it.desc}</div><div class='price'>R${it.price.toFixed(2)}</div><button class='button primary' data-add='${it.name}' data-restaurant='${escapedName}'>Add</button>`;
        list.appendChild(el);
      });
      
      const ms=$('#menu-search');
      if(ms){ ms.value=''; ms.oninput=()=>{
        const q=ms.value.trim().toLowerCase();
        $$('#menu-list .menu-item').forEach(card=>{
          const nameTxt=card.querySelector('h3').textContent.toLowerCase();
          card.style.display = nameTxt.includes(q)?'grid':'none';
        });
      }}
      updateCartCount();
      show('menu');
    }

    // Event listener for adding items to cart
    $('#menu-list').addEventListener('click', (e)=>{
      const b = e.target.closest('[data-add]'); 
      if(!b) return;
      
      const itemName = b.getAttribute('data-add');
      const itemRestaurant = b.getAttribute('data-restaurant');
      
      // Find the item details from the master list
      const it = (ALL_RESTAURANTS[itemRestaurant]?.menu || []).find(x => x.name === itemName);
      if(!it) {
        console.error('Could not find item in ALL_RESTAURANTS', itemRestaurant, itemName);
        return; // Item not found, something is wrong
      }

      const cartState = getCartState();
      
      // LOGIC: Block adding from a different restaurant
      if (cartState.restaurant && cartState.restaurant !== itemRestaurant) {
        showToast("One Place at aTime!", `Your cart is locked to ${cartState.restaurant}. You can't add items from ${itemRestaurant} until you clear your cart.`);
        return;
      }

      // If cart is empty, set the restaurant
      if (!cartState.restaurant) {
        cartState.restaurant = itemRestaurant;
      }

      const ex = cartState.items.find(x => x.name === itemName);
      if(ex) {
        ex.qty += 1; // Increment existing
      } else {
        cartState.items.push({name: it.name, price: it.price, qty: 1}); // Add new
      }
      
      saveCartState(cartState);
      
      // NEW: Show "Item Added" toast
      showItemAddedToast(`Added ${it.name} to cart!`);
    });

    // ----- Cart -----
    function renderCart(){
      const cartState = getCartState();
      const cart = cartState.items;
      const items=$('#cart-items-container');
      const total=$('#cart-total-price');
      items.innerHTML=''; let sum=0;
      
      if(cart.length===0){ 
        items.innerHTML='<div class="muted" style="padding: 16px 0; text-align: center;">Your cart is empty. Browse restaurants to add items.</div>'; 
        total.textContent='R0.00'; 
        
        // NEW: Clear restaurant lock if cart is manually emptied
        if (cartState.restaurant) {
          clearCart(); // This will save { items: [], restaurant: null }
        }
        return; 
      }
      
      // If we are here, cart has items, so show which restaurant it's from
      const restaurantHeader = document.createElement('div');
      restaurantHeader.className = 'muted';
      restaurantHeader.style.cssText = 'font-weight: 800; text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--line);';
      restaurantHeader.textContent = `Your Order from: ${cartState.restaurant}`;
      items.appendChild(restaurantHeader);
      
      cart.forEach(i=>{
        const line=i.price*i.qty; sum+=line;
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div>${i.name}</div>
          <div class='qty'>
            <button class='qbtn' aria-label='Decrease' data-dec='${i.name}'>−</button>
            <div aria-live='polite'>${i.qty}</div>
            <button class='qbtn' aria-label='Increase' data-inc='${i.name}'>+</button>
          </div>
          <div>R${line.toFixed(2)}</div>
          <button class='remove' aria-label='Remove item' data-remove='${i.name}'>×</button>`;
        items.appendChild(row);
      });
      total.textContent=`R${sum.toFixed(2)}`;
    }

    $('#cart-items-container').addEventListener('click',(e)=>{
      const inc=e.target.closest('[data-inc]');
      const dec=e.target.closest('[data-dec]');
      const rem=e.target.closest('[data-remove]');
      if(!inc && !dec && !rem) return;
      
      const cartState = getCartState();
      const key=(inc||dec||rem).getAttribute('data-inc')|| (inc||dec||rem).getAttribute('data-dec') || (inc||dec||rem).getAttribute('data-remove');
      const itemIndex = cartState.items.findIndex(x => x.name === key);
      
      if(itemIndex === -1) return; // Item not found
      
      if(inc) {
        cartState.items[itemIndex].qty += 1;
      }
      if(dec){ 
        cartState.items[itemIndex].qty -= 1; 
        if(cartState.items[itemIndex].qty <= 0) {
          cartState.items.splice(itemIndex, 1); // Remove item
        }
      }
      if(rem){ 
        cartState.items.splice(itemIndex, 1); // Remove item
      }
      
      // NEW: If last item is removed, clear restaurant lock
      if (cartState.items.length === 0) {
        cartState.restaurant = null;
      }
      
      saveCartState(cartState);
      renderCart(); // Re-render cart
    });

    // ----- WhatsApp message (preview-first) -----
    // NEW: Function to open a clean WhatsApp popup
    function openWhatsAppPopup(url) {
      const w = 600;
      const h = 800;
      const left = (screen.width / 2) - (w / 2);
      const top = (screen.height / 2) - (h / 2);
      window.open(url, 'WhatsApp', `width=${w},height=${h},top=${top},left=${left},resizable=yes,scrollbars=yes`);
    }

    function generateWhatsApp(){
      const cartState = getCartState();
      const cart = cartState.items;
      
      if(cart.length===0){ 
        // UPDATED:
        showToast("Empty Cart!", "Trying to order... nothing? Add some items to your cart first, mastermind.");
        return; 
      }
      const zone=localStorage.getItem('weDeliverZone')||'Zone Not Selected';
      const name=$('#df-name')?.value.trim();
      const phone=$('#df-phone')?.value.trim();
      const address=$('#df-address')?.value.trim();
      const notes=$('#df-notes')?.value.trim();
      
      if(!name||!phone||!address){
        // UPDATED:
        let missing = !name ? 'your name' : !phone ? 'your phone number' : 'your address';
        showToast("Details, Please!", `You're not a mind reader, and neither are we. Please fill in ${missing}.`);
        
        if(!name) { $('#df-name').focus(); return; }
        if(!phone) { $('#df-phone').focus(); return; }
        $('#df-address').focus();
        return;
      }

      // NEW: Get Order Number
      const orderNumber = getOrderNumber();
      const now = new Date();
      const orderDate = now.toLocaleDateString('en-ZA'); // e.g., 2025/11/09
      const orderTime = now.toLocaleTimeString('en-US', { timeZone: 'Africa/Johannesburg', hour: '2-digit', minute: '2-digit', hour12: true });

      let total=0;
      const lines = [
        `*WE DELIVER - ORDER ${orderNumber}*`,
        '',
        `*From:* ${cartState.restaurant}`, // Add restaurant name
        `*Delivery Zone:* ${zone}`,
        '',
        '*Customer Details:*',
        `*Name:* ${name}`,
        `*Phone:* ${phone}`,
        `*Address:* ${address}`,
      ];
      if(notes) lines.push(`*Notes:* ${notes}`);
      lines.push('', '*Order Items:*');
      cart.forEach(i=>{ const line=i.price*i.qty; total+=line; lines.push(`- ${i.qty}x ${i.name} (R${line.toFixed(2)})`); });
      lines.push('', `*TOTAL (excl. delivery): R${total.toFixed(2)}*`, '', 'Please confirm this order and send payment (EFT/eWallet) details.');
      const msg = lines.join('\n');
      const waNumber = getWaNumber();
      const link=`https://wa.me/${waNumber}?text=${encodeURIComponent(msg)}`;
      
      // NEW: Populate and show modal
      $('#modal-order-number').textContent = orderNumber;
      $('#modal-order-date').textContent = orderDate;
      $('#modal-order-time').textContent = orderTime;
      $('#modal-preview-output').textContent = msg;
      $('#modal-send-wa').setAttribute('data-link', link); // Store link in data attribute
      $('#order-preview-modal').style.display = 'flex';
      
      // NEW: Hide initial footer, show confirm/cancel footer
      $('#order-modal-footer').style.display = 'grid';
      $('#confirm-wa-footer').style.display = 'none';
    }
    
    // Order Preview Modal close logic
    function initModal() {
      const modal = $('#order-preview-modal');
      const closeBtn = $('#modal-close-btn');
      const sendBtn = $('#modal-send-wa');
      
      // NEW: Confirmation step buttons
      const confirmFooter = $('#confirm-wa-footer');
      const orderFooter = $('#order-modal-footer');
      const confirmOpenBtn = $('#confirm-wa-open');
      const confirmCancelBtn = $('#confirm-wa-cancel');

      const closeModal = () => {
        modal.style.display = 'none';
      };

      // Close on 'X' button
      closeBtn.addEventListener('click', closeModal);
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // Handle "Send to We Deliver" click -> SHOWS CONFIRMATION
      sendBtn.addEventListener('click', (e) => {
        e.preventDefault();
        orderFooter.style.display = 'none';
        confirmFooter.style.display = 'grid';
      });
      
      // Handle "Cancel" from main modal
      $('#modal-cancel-btn').addEventListener('click', closeModal);
      
      // Handle "Cancel" from *confirmation* step
      confirmCancelBtn.addEventListener('click', () => {
        // Just go back to the order summary
        orderFooter.style.display = 'grid';
        confirmFooter.style.display = 'none';
      });
      
      // Handle FINAL "Open WhatsApp" click
      confirmOpenBtn.addEventListener('click', () => {
        const link = sendBtn.getAttribute('data-link');
        
        // Open popup
        openWhatsAppPopup(link);
        
        // Clear cart, close modal, and show success page
        clearCart(); // This now clears state and count
        closeModal();
        show('success'); 
        
        // NEW: Show "Check WhatsApp" toast on the success page
        setTimeout(() => {
          showItemAddedToast("Order sent! Check WhatsApp to confirm.");
        }, 500);
      });
    }
    
    // NEW: Toast Modal close logic
    function initToastModal() {
      const modal = $('#toast-modal');
      const closeBtn = $('#toast-close-btn');

      const closeModal = () => {
        modal.style.display = 'none';
      };

      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }


    // ----- Nav & boot -----
    // Listen to all nav links (desktop and mobile)
    $$('[data-nav]').forEach(n=> n.addEventListener('click', (e)=>{
      const targetNav = n.dataset.nav;
      
      // NEW: Check for disabled mobile nav link
      if (n.classList.contains('disabled')) {
        e.preventDefault(); // Stop navigation
        showToast("Not So Fast!", "Our drivers are resting their wheels. We're closed! Check back later.");
        return;
      }
      
      // NEW: Centralized zone check for all nav actions
      const needsZone = (targetNav === 'restaurants' || targetNav === 'menu' || targetNav === 'cart');
      if(needsZone && !localStorage.getItem('weDeliverZone')){
        e.preventDefault(); // Stop navigation
        showToast("Whoa There!", "Please select your delivery zone first. We can't deliver to '???'.");
        show('index'); // Force back to index
        document.querySelector('.zone-panel')?.scrollIntoView({behavior:'smooth',block:'start'});
        return; // Stop the function
      }
      
      e.preventDefault();
      show(targetNav);
    }));

    document.getElementById('place-order').addEventListener('click', generateWhatsApp);

    function setOfflineFallbacks(){
      // Replaced with placehold.co, so this is less critical
      // but good practice.
      document.querySelectorAll('.ride-photos img').forEach(img=>{
        img.loading='lazy';
        img.addEventListener('error',()=>{ 
          img.style.opacity=1; 
          img.src = 'https://placehold.co/1600x900/0B0E10/D4AF37?text=Error+Loading+Image';
        });
      });
    }
    document.addEventListener('DOMContentLoaded',()=>{ 
      initIndex();
      updateCartCount(); // Initial cart count
      setOfflineFallbacks();
      initModal(); // Initialize order modal
      initToastModal(); // NEW: Initialize toast modal
      // Show initial view
      show('index');
      
      // Run the master updater once immediately, then every second
      masterTimeUpdater();
      setInterval(masterTimeUpdater, 1000);
    });

    // ===== Tests (run with ?test=1) =====
    (function tests(){
      const q=new URLSearchParams(location.search); if(q.get('test')!=='1') return;
      const panel=document.createElement('div'); panel.id='tpanel'; panel.style.cssText='position:fixed;right:10px;bottom:10px;background:#fff;border:1px solid #ddd;padding:8px;border-radius:8px;max-width:320px;z-index:1000;font:12px/1.2 system-ui'; panel.innerHTML='<b>Dev Tests</b><div id="log"></div>'; document.body.appendChild(panel);
      const log=(ok,m)=>{const d=document.createElement('div');d.style.color=ok?'#0a0':'#b00';d.textContent=(ok?'✓ ':'✗ ')+m;document.getElementById('log').appendChild(d)};
      try{
        log(document.querySelectorAll('#quick-zones .pill').length===6,'Zone chips count = 6');
        const pill=document.querySelector('#quick-zones .pill'); pill && pill.click();
        log(!!localStorage.getItem('weDeliverZone'),'Zone chip selection persists');
        document.getElementById('hero-start').click();
        log(document.getElementById('view-restaurants').style.display==='block','Navigate to restaurants');
        const rs=document.getElementById('rest-search'); rs.value='Kasi'; rs.dispatchEvent(new Event('input'));
        const visibleCards=[...document.querySelectorAll('#restaurant-list .rest')].filter(el=>getComputedStyle(el).display!=='none').length;
        log(visibleCards>=1,'Restaurant search filters');
        
        // Test dynamic restaurant list
        const firstRest = document.querySelector('#restaurant-list .rest');
        if (firstRest) {
          firstRest.click();
          log(document.getElementById('view-menu').style.display==='block','Open menu');
          
          const addBtn = document.querySelector('#menu-list [data-add]');
          if (addBtn) {
            addBtn.click();
            addBtn.click();
            updateCartCount();
            log(document.getElementById('view-cart-btn').textContent.includes('2'),'Cart increments (2)');
          } else {
            log(false, 'Could not find "Add" button on menu');
          }
        } else {
          log(false, 'Could not find first restaurant in dynamic list');
        }

        show('cart');
        renderCart();
        const firstDec=document.querySelector('#cart-items-container [data-dec]'); firstDec && firstDec.click();
        renderCart();
        const qtyAfter=document.querySelector('#cart-items-container [aria-live]')?.textContent;
        log(qtyAfter==='1','Decrement works');
        const removeBtn=document.querySelector('#cart-items-container [data-remove]'); removeBtn && removeBtn.click();
        renderCart();
        log(document.getElementById('cart-items-container').textContent.includes('empty')||document.getElementById('cart-items-container').children.length>=0,'Remove works');
        document.getElementById('df-name').value='Test User';
        document.getElementById('df-phone').value='0812345678';
        document.getElementById('df-address').value='123 Sample Street';
        document.getElementById('place-order').click();
        log(document.getElementById('modal-preview-output').textContent.includes('Test User'),'WA message includes customer details');
        const sendBtn=document.getElementById('modal-send-wa');
        log(!!sendBtn && sendBtn.getAttribute('data-link').includes('wa.me'),'Send button present with wa.me link');
      }catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>
